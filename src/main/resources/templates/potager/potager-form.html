<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/head :: head"><title></title></head>

<body>

<header th:replace="fragments/header :: header">header</header>

<div class="container mt-4">
	<nav aria-label="breadcrumb">
		<ol class="breadcrumb">
			<li class="breadcrumb-item"><a th:href="@{/potager/list}">Potagers</a></li>
			<li class="breadcrumb-item active" aria-current="page">Crée un nouveau potager</li>
		</ol>
	</nav>
</div>

<div class="container mt-5 my-container">

	<form id="myForm" th:action="@{/potager/valider}" th:object="${potager}" method="post">
		<div class="mb-3">
			<label class="form-label">Nom</label>
			<input class="form-control" type="text" th:field="*{name}" title="nom du potager">
			<span th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>
		</div>
		<div class="mb-3">
			<label class="form-label">Surface (m²)</label>
			<input class="form-control" type="number" th:field="*{surface}" title="surface du potager">
			<span th:if="${#fields.hasErrors('surface')}" th:errors="*{surface}"></span>
		</div>
		<div class="mb-3">
			<label class="form-label">Code postal</label>
			<input id="zipCode" class="form-control" type="text" th:field="*{zipCode}" title="code postal">
			<span id="zipCodeErrorTh" th:if="${#fields.hasErrors('zipCode')}" th:errors="*{zipCode}"></span>
			<span id="zipCodeError"></span>
		</div>
		<div class="mb-3">
			<label for="cities" class="form-label">Ville</label>
			<select id="cities" th:field="*{city}">
				<option value="">
					Rentre un code postal pour avoir une liste de ville
				</option>
			</select>
			<span id="citiesError" th:if="${#fields.hasErrors('city')}" th:errors="*{city}"></span>
		</div>
		<input class="btn btn-success" type="submit" value="Crée un nouveau potager">
	</form>

</div>

<footer th:replace="fragments/footer :: footer">footer</footer>

<div th:replace="fragments/script :: script">script</div>

<script type="text/javascript">
	const zipCode = document.getElementById("zipCode");

	zipCode.addEventListener('change', () => {
		sendData();
	});

	function sendData() {

		const form = document.getElementById("myForm");

		const XHR = new XMLHttpRequest();

		// Bind the FormData object and the form element
		const FD = new FormData(form);

		// Define what happens on successful data submission
		XHR.addEventListener( "load", function(event) {
			const zipCodeErrorTh = document.getElementById("zipCodeErrorTh");
			if (zipCodeErrorTh != null) {
				zipCodeErrorTh.innerHTML = "";
			}
			const citiesError = document.getElementById("citiesError");
			if (citiesError != null) {
				citiesError.innerHTML = "";
			}
			let str = event.target.responseText;
			if (str.includes("error")) {
				const zipCodeError = document.getElementById("zipCodeError");
				zipCodeError.innerHTML = "Code postal non valide";
				const select = document.getElementById("cities");
				select.innerHTML = "";
				const option = document.createElement("option");
				option.value = "";
				option.innerHTML = "Rentre un code postal pour avoir une liste de ville";
				select.appendChild(option);
			} else {
				str = str.replace("[", "");
				str = str.replace("]", "");
				str = str.replace(/ /g, "");
				str = str.replace(/"/g, "");
				const cities = str.split(',');
				const select = document.getElementById("cities");
				select.innerHTML = "";
				for (let i = 0; i < cities.length; i++) {
					const option = document.createElement("option");
					option.value = cities[i];
					option.innerHTML = cities[i];
					select.appendChild(option);
				}
			}
		} );

		// Set up our request
		XHR.open("POST", "http://localhost:8081/patatapp/ws/cities");

		// The data sent is what the user provided in the form
		XHR.send(FD);
	}
</script>

</body>
</html>